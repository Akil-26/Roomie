rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Deny by default
    match /{document=**} {
      allow read, write: if false;
    }

    // User profiles
    // Readable by authenticated users (to show names/avatars), writable only by the owner
    match /users/{userId} {
      allow read: if request.auth != null; // profiles are visible to signed-in users
      
      // ðŸ”’ SECURITY: Only owner can write, and email must be unique or unchanged
      allow create: if request.auth != null && request.auth.uid == userId;
      
      allow update: if request.auth != null 
        && request.auth.uid == userId
        && (
          // Email unchanged OR new email is unique
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['email'])
          || !exists(/databases/$(database)/documents/users/$(request.auth.uid))
        );
      
      // ðŸ”’ No client-side deletion
      allow delete: if false;

      // Subcollections: followers/following
      match /following/{targetUserId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == userId;
      }
      match /followers/{followerUserId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null && request.auth.uid == followerUserId;
      }

      // Notifications scoped to a user
      match /notifications/{notificationId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      // SMS Transactions subcollection - owner only
      match /sms_transactions/{transactionId} {
        allow read, write: if request.auth != null && request.auth.uid == userId
          && isValidSmsTransaction();

        function isValidSmsTransaction() {
          return request.resource.data.keys().hasOnly([
              'id','userId','type','amount','timestamp','merchantName','bankName','upiId','mode','accountNumber',
              'referenceNumber','rawMessage','category','senderNumber'
            ])
            && request.resource.data.userId == request.auth.uid
            && request.resource.data.type in ['debit','credit']
            && request.resource.data.amount is number
            && request.resource.data.timestamp is timestamp;
        }
      }
    }

    // Groups collection
    // Browse groups when signed in; updates allowed to members of the group only
    // IMPORTANT: Groups (rooms) should NEVER be deleted, only deactivated (status change)
    match /groups/{groupId} {
      allow read: if request.auth != null;
      // Create allowed if creator is the current user and they are in the members list
      allow create: if request.auth != null &&
        request.resource.data.createdBy == request.auth.uid &&
        request.resource.data.members is list &&
        request.auth.uid in request.resource.data.members;

      // Update allowed only to members of the group
      // Delete is intentionally NOT allowed to ensure room persistence
      allow update: if request.auth != null &&
        resource.data.members is list &&
        request.auth.uid in resource.data.members;
      
      // IMPORTANT: Rooms should never be deleted - only status changed to 'inactive'
      allow delete: if false;
    }

    // Room Members collection - tracks user-room relationships
    // This is separate from the room itself to track membership history
    match /room_members/{memberId} {
      // Users can read their own membership records
      // Group members can read other members' records for the same room
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid in get(/databases/$(database)/documents/groups/$(resource.data.roomId)).data.members
      );
      
      // Only authenticated users can create membership records for themselves
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid;
      
      // Users can update their own records (e.g., when leaving)
      // Group admins can also update member records
      allow update: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        request.auth.uid in get(/databases/$(database)/documents/groups/$(resource.data.roomId)).data.members
      );
      
      // Membership records should never be deleted - only marked inactive
      allow delete: if false;
    }

    // Join requests
    // Create: requester must be the authenticated user
    // Read: requester or any member of the target group
    // Update/Delete: requester can modify own request, or group members can change status
    match /joinRequests/{requestId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;

      function isGroupMember(groupId) {
        return request.auth != null &&
          (request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members);
      }

      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        (resource.data.groupId is string && isGroupMember(resource.data.groupId))
      );

      allow update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        (resource.data.groupId is string && isGroupMember(resource.data.groupId))
      );
    }

    // ============================================================
    // STEP-2: Room Ownership Requests
    // ============================================================
    // Owner can request to manage an existing room
    // Only room creator (admin) can approve/reject
    // Room ID never changes - just sets room.ownerId on approval
    match /room_ownership_requests/{requestId} {
      // Owner can read their own requests
      // Room creator can read requests for their rooms
      allow read: if request.auth != null && (
        resource.data.ownerId == request.auth.uid ||
        request.auth.uid == get(/databases/$(database)/documents/groups/$(resource.data.roomId)).data.createdBy
      );
      
      // Only authenticated users can create ownership requests for themselves
      allow create: if request.auth != null &&
        request.resource.data.ownerId == request.auth.uid &&
        request.resource.data.status == 'pending';
      
      // Only room creator can update (approve/reject)
      // Owner cannot modify their own request after creation
      allow update: if request.auth != null &&
        request.auth.uid == get(/databases/$(database)/documents/groups/$(resource.data.roomId)).data.createdBy;
      
      // Ownership requests should not be deleted
      allow delete: if false;
    }

    // ============================================================
    // STEP-3: Room Payments (Owner Space Only)
    // ============================================================
    // CRITICAL: Payments belong to OWNER SPACE only
    // Private roommate space must NEVER see or access payments
    // Payments are NOT linked to: room_members, private chat, expenses, groceries
    match /room_payments/{paymentId} {
      // Owner can read ALL payments for their rooms
      // Payer can read ONLY their own payments
      allow read: if request.auth != null && (
        // Payer can read their own payment records
        resource.data.payerId == request.auth.uid ||
        // Owner can read all payments for rooms they own
        resource.data.ownerId == request.auth.uid
      );
      
      // Authenticated users can create payment records for themselves
      allow create: if request.auth != null &&
        request.resource.data.payerId == request.auth.uid &&
        request.resource.data.status == 'pending';
      
      // Only the system (via the service) can update payment status
      // Payer can update their own pending payments
      allow update: if request.auth != null && (
        // Payer can update their own payment (for status changes)
        resource.data.payerId == request.auth.uid
      );
      
      // Payment records should never be deleted (for audit trail)
      allow delete: if false;
    }

    // ============================================================
    // STEP-4: Room Join Requests
    // ============================================================
    // Students can request to join owner-created rooms
    // Owner approves/rejects - creates USER_ROOM_LINK on approval
    match /room_join_requests/{requestId} {
      // Requester can read their own requests
      // Owner can read requests for their rooms
      allow read: if request.auth != null && (
        // Requester can read their own join requests
        resource.data.userId == request.auth.uid ||
        // Owner can read join requests for rooms they own
        // (Note: Owner check happens at service level for roomId lookup)
        true
      );
      
      // Authenticated users can create join requests for themselves
      allow create: if request.auth != null &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.status == 'pending';
      
      // Owner can update request status (approve/reject)
      allow update: if request.auth != null;
      
      // Join requests should not be deleted (for audit trail)
      allow delete: if false;
    }

    // Per-user notifications top-level collection (if used):
    match /users/{userId}/notifications/{notificationId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ðŸ’¬ CHAT MESSAGES (Direct & Group)
    match /chats/{chatId}/messages/{messageId} {
      // Only participants can read messages
      allow read: if request.auth != null;
      
      // Only authenticated users can create messages
      allow create: if request.auth != null 
        && request.resource.data.senderId == request.auth.uid;
      
      // Only sender can update (for edit/delete)
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.senderId;
      
      allow delete: if request.auth != null 
        && request.auth.uid == resource.data.senderId;
    }

    // Group messages
    match /groups/{groupId}/messages/{messageId} {
      // Only group members can read
      allow read: if request.auth != null 
        && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members;
      
      // Only group members can create messages
      allow create: if request.auth != null 
        && request.auth.uid in get(/databases/$(database)/documents/groups/$(groupId)).data.members
        && request.resource.data.senderId == request.auth.uid;
      
      // Only sender can update/delete
      allow update: if request.auth != null 
        && request.auth.uid == resource.data.senderId;
      
      allow delete: if request.auth != null 
        && request.auth.uid == resource.data.senderId;
    }

    // ðŸ’¸ EXPENSES
    match /expenses/{expenseId} {
      // Group members can read group expenses
      allow read: if request.auth != null && (
        request.auth.uid == resource.data.paidBy
        || request.auth.uid in resource.data.participants
      );
      
      // Anyone can create expense if they're the payer
      allow create: if request.auth != null 
        && request.resource.data.paidBy == request.auth.uid;
      
      // Only payer can update/delete
      allow update, delete: if request.auth != null 
        && request.auth.uid == resource.data.paidBy;
    }

    // ðŸ”” PUSH NOTIFICATIONS QUEUE
    // Used by Cloud Functions to send FCM push notifications
    match /push_notifications/{notificationId} {
      // Authenticated users can create push notification requests
      allow create: if request.auth != null;
      
      // Only Cloud Functions can read/update/delete (via admin SDK)
      allow read, update, delete: if false;
    }
  }
}